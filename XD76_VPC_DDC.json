{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "**Version 1.08, 3-3-2016** STEP-XD This template creates and installs the XenDesktop base infrastructure into a subnet inside a VPC. **WARNING** This template creates Amazon EC2 Windows instance and related resources. You will be billed for the AWS resources used if you create a stack from this template.",

  "Parameters" : {

        "KeyPairName" : {
            "Description" : "Public/private key pairs allow you to securely connect to your instance after it launches",
            "Type"        : "String"
        },
		"DDCInstanceType" : {
			"Description" : "Amazon EC2 instance type for the XenApp/XenDesktop 7.x Delivery Controller Instances",
			"Type" : "String",
			"Default" : "m4.large",
			"AllowedValues" : [ "m4.large","m3.medium","m3.large","t2.medium", "t2.large", "c4.large", "c4.xlarge", "c3.large", "c3.xlarge"]
		},
		"DomainDNSName":{
         "Description":"Fully qualified domain name (FQDN) to be used for the DHCP scop e.g. xencloud.net",
         "Type":"String",
         "Default":"xencloud.net",
         "MinLength":"3",
         "MaxLength":"25",
         "AllowedPattern":"[a-zA-Z0-9]+\\..+"
      },
		"DomainNetBIOSName"   : {
            "Description" : "NetBIOS name for the domain (XENCLOUD)",
            "Type"        : "String",
            "Default"     : "XENCLOUD"
        },
        "DDCServerNetBIOSName1" : {
            "Description" : "NetBIOS name of the 1st Delivery Controller (upto 15 characters) located in AZ1",
            "Type"        : "String",
            "Default"     : "XD7DDC01",
            "MinLength"   : "1",
            "MaxLength"   : "15",
            "AllowedPattern" : "[a-zA-Z0-9]+"
        },
        "DDCServerNetBIOSName2" : {
            "Description" : "NetBIOS name of the 2nd XenDesktop Delivery Controller (upto 15 characters)",
            "Type"        : "String",
            "Default"     : "XD7DDC02",
            "MinLength"   : "1",
            "MaxLength"   : "15",
            "AllowedPattern" : "[a-zA-Z0-9]+"
        },
        "ADServerNetBIOSName1"  : {
            "Description" : "NetBIOS name of the existing Domain Controller in AZ1",
            "Type"        : "String",
            "Default"     : "DC1",
            "MinLength"   : "1",
            "MaxLength"   : "15",
            "AllowedPattern" : "[a-zA-Z0-9]+"
        },
        "ADServerNetBIOSName2"  : {
            "Description" : "NetBIOS name of the existing Domain Controller in AZ2",
            "Type"        : "String",
            "Default"     : "DC2",
            "MinLength"   : "1",
            "MaxLength"   : "15",
            "AllowedPattern" : "[a-zA-Z0-9]+"
        },
        "WSFCNode1NetBIOSName"		: {
            "Description" : "NetBIOS name of the 1st WSFC Node (up to 15 characters)",
            "Type"        : "String",
            "Default"     : "WSFCNode1",
            "MinLength"   : "1",
            "MaxLength"   : "15",
            "AllowedPattern" : "[a-zA-Z0-9]+"
        },
        "WSFCNode2NetBIOSName"		: {
            "Description" : "NetBIOS name of the 2nd WSFC Node (up to 15 characters)",
            "Type"        : "String",
            "Default"     : "WSFCNode2",
            "MinLength"   : "1",
            "MaxLength"   : "15",
            "AllowedPattern" : "[a-zA-Z0-9]+"
        },
        "DomainAdminUser"      : {
            "Description" : "User name for the account that will be added as Domain Administrator. This is separate from the default \"Administrator\" account",
            "Type"        : "String",
            "Default"     : "XenAdmin",
            "MinLength"   : "5",
            "MaxLength"   : "25",
            "AllowedPattern" : "[a-zA-Z0-9]*"
        },
        "DomainAdminPassword"  : {
            "Description" : "Password for the domain admin user. Must be at least 8 characters containing letters, numbers and symbols",
            "Type"        : "String",
            "MinLength"   : "8",
            "MaxLength"   : "32",
            "AllowedPattern" : "(?=^.{6,255}$)((?=.*\\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*",
            "NoEcho"         : "True"
        },
        "ADServer1PrivateIp"        : {
            "Description" : "Fixed private IP for the first existing Active Directory server located in AZ1",
            "Type"        : "String",
            "Default"     : "10.16.3.5"
        },
        "ADServer2PrivateIp"        : {
            "Description" : "Fixed private IP for the second existing Active Directory serverr located in AZ2",
            "Type"        : "String",
            "Default"     : "10.16.4.5"
        },
        "DomainMemberSGID"          : {
            "Description" : "ID of the Domain Member Security Group (e.g., sg-7f16e910)",
            "Type"        : "String"
        },
        "DDCSGID"          : {
            "Description" : "ID of the XenDesktop Delivery Controller Security Group (e.g., sg-7f16e910)",
            "Type"        : "String"
        },
		"VPC"                       : {
            "Description" : "ID of the VPC (e.g., vpc-0343606e)",
            "Type"        : "String"
        },
        "InfraSubnet1Id"          : {
            "Description" : "ID of the subnet you want to provision the first Delivery Contoller into (e.g., subnet-a0246dcd)",
            "Type"        : "String"
        },
        "InfraSubnet2Id"          : {
            "Description" : "ID of the subnet you want to provision the second WSFC node into (e.g., subnet-e3246d8e)",
            "Type"        : "String"
        },
        "XDVersion"					: {
            "Description" : "Version of XenDesktop 7 to install. Options include either \"XD75\" \"XD76\" \"XD77\" or \"XD78\"",
            "Type"        : "String",
            "AllowedValues" : [
                "XD75",
                "XD76",
				"XD77",
				"XD78"
            ],
            "Default"       : "XD76"
        }
	},
 	"Mappings" : {
        "AWSInstanceType2Arch" : {
            "t2.micro"  : {
                "Arch" : "64"
            },
            "t2.small"  : {
                "Arch" : "64"
            },
            "t2.medium" : {
                "Arch" : "64"
            },
            "t2.large" : {
                "Arch" : "64"
            },
            "m4.large" : {
                "Arch" : "64"
            },
            "m4.xlarge" : {
                "Arch" : "64"
            },
            "m3.medium"  : {
                "Arch" : "64"
            },
            "m3.large"  : {
                "Arch" : "64"
            },
            "m3.xlarge"  : {
                "Arch" : "64"
            },
            "c4.large"  : {
                "Arch" : "64"
            },
            "c4.xlarge"  : {
                "Arch" : "64"
            },
            "c4.2xlarge"  : {
                "Arch" : "64"
            },
			"c3.large"  : {
                "Arch" : "64"
            },
            "c3.xlarge"  : {
                "Arch" : "64"
            },
            "c3.2xlarge"  : {
                "Arch" : "64"
            },
			"r3.large"  : {
                "Arch" : "64"
            },
            "r3.xlarge"  : {
                "Arch" : "64"
            }
            
        },
        "AWSRegionArch2AMI"    : {
            "us-east-1" : {
                "64" : "ami-c8a9baa2"
            },
            "us-west-2" : {
                "64" : "ami-87c037e7"
            },
            "us-west-1" : {
                "64" : "ami-032f5063"
            },
            "eu-west-1" : {
                "64" : "ami-9ebb39ed"
            },
            "eu-central-1" : {
                "64" : "ami-3acf2f55"
            },
            "ap-southeast-1" : {
                "64" : "ami-63489d00"
            },
            "ap-northeast-1" : {
                "64" : "ami-ff435e91"
            },
            "ap-northeast-2" : {
                "64" : "ami-c6de16a8"
            },
            "ap-southeast-2" : {
                "64" : "ami-16645a75"
            },
			"sa-east-1"      : {
                "64" : "ami-6efd7302"
            }
        }

	},
  "Resources" : {
		"XD7DDC1":{
			"Type":"AWS::EC2::Instance",
            "Metadata" : {
                "AWS::CloudFormation::Init" : {
                    "configSets" : {
                        "config" : [
                            "CFNsetup",
                            "rename",
                            "join",
                            "installXD",
                            "finalize"
                        ]
                    },
                    "CFNsetup"   : {
                        "files" : {
                            "c:\\cfn\\cfn-hup.conf" : {
                                "content" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "[main]\n",
                                            "stack=",
                                            {
                                                "Ref" : "AWS::StackId"
                                            },
                                            "\n",
                                            "region=",
                                            {
                                                "Ref" : "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf" : {
                                "content" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "[cfn-auto-reloader-hook]\n",
                                            "triggers=post.update\n",
                                            "path=Resources.XD7DDC1.Metadata.AWS::CloudFormation::Init\n",
                                            "action=cfn-init.exe -v -s ",
                                            {
                                                "Ref" : "AWS::StackId"
                                            },
                                            " -r XD7DDC1",
                                            " --region ",
                                            {
                                                "Ref" : "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            }
                        },
                        "services" : {
                            "windows" : {
                                "cfn-hup" : {
                                    "enabled" : "true",
                                    "ensureRunning" : "true",
                                    "files"         : [
                                        "c:\\cfn\\cfn-hup.conf",
                                        "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        },
						"commands" : {
                            "a-set-execution-policy" : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -command Set-ExecutionPolicy RemoteSigned -Force"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            }
                        }
                    },
                    "rename"     : {
                        "commands" : {
                            "1-execute-powershell-script-RenameComputer" : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command Rename-Computer -NewName ",
                                            {
                                                "Ref" : "DDCServerNetBIOSName1"
                                            },
                                            " -Restart"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "forever"
                            }
                        }
                    },
                    "join"       : {
                        "commands" : {
                            "a-set-dns-servers" : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command ",
                                            "\"",
                                            "Get-NetAdapter | Set-DnsClientServerAddress -ServerAddresses ",
                                            {
                                                "Ref" : "ADServer1PrivateIp"
                                            },
                                            ",",
                                            {
                                                "Ref" : "ADServer2PrivateIp"
                                            },
                                            "\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "30"
                            },
                            "b-join-domain"     : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-Command \"",
                                            "Add-Computer -DomainName ",
                                            {
                                                "Ref" : "DomainDNSName"
                                            },
                                            " -Credential ",
                                            "(New-Object System.Management.Automation.PSCredential('",
                                            {
                                                "Ref" : "DomainNetBIOSName"
                                            },
                                            "\\",
                                            {
                                                "Ref" : "DomainAdminUser"
                                            },
                                            "',",
                                            "(ConvertTo-SecureString ",
                                            {
                                                "Ref" : "DomainAdminPassword"
                                            },
                                            " -AsPlainText -Force))) ",
                                            "-Restart\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "forever"
                            }
                        }
                    },
                    "installXD"       : {
                        "files" : {
                            "c:\\cfn\\scripts\\DownloadXDISO.ps1" : {
                                "source" : "https://s3.amazonaws.com/cf-XenDesktop/RA/Scripts/DownloadXD.ps1"
                            },
                            "c:\\cfn\\scripts\\configureXD.ps1" : {
                                "source" : "https://s3.amazonaws.com/cf-XenDesktop/RA/Scripts/XD7-DC1-Config.ps1"
                            },
                            "C:\\cfn\\scripts\\AddUserToGroup.ps1" : {
                                "content" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "Param(",
                                            "\n",
                                            "[Parameter(Mandatory=$True)]",
                                            "\n",
                                            "[string]$ServerName,",
                                            "\n",
                                            "[Parameter(Mandatory=$True)]",
                                            "\n",
                                            "[string]$GroupName,",
                                            "\n",
                                            "[Parameter(Mandatory=$True)]",
                                            "\n",
                                            "[string]$DomainNetBIOSName,",
                                            "\n",
                                            "[Parameter(Mandatory=$True)]",
                                            "\n",
                                            "[string]$UserName",
                                            "\n",
                                            ")",
                                            "$de = [ADSI]\"WinNT://$ServerName/$GroupName,group\"",
                                            "\n",
                                            "$de.psbase.Invoke(\"Add\",([ADSI]\"WinNT://$DomainNetBIOSName/$UserName\").path)",
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "C:\\Users\\Default\\Desktop\\InstallXDDDC.bat" : {
                                "content" : {
                                    "Fn::Join" : [
                                        "",
                                        [
											"powershell.exe -command Install-WindowsFeature NET-Framework-Core",
											"\n",
                                            "powershell.exe -command \"dir \\\\",
                                            {
                                                "Ref" : "ADServerNetBIOSName1"
                                            },
                                            "\\XDinstall\\*.iso | Mount-DiskImage\"",
                                            "\n",
											"\"",
											"D:\\X64\\XenDesktop Setup\\XENDESKTOPSERVERSETUP.EXE",
											"\" ",
                                            "/COMPONENTS ",
                                            "CONTROLLER,DESKTOPSTUDIO,DESKTOPDIRECTOR,LICENSESERVER,STOREFRONT ",
                                            "/PASSIVE ",
                                            "/NOREBOOT ",
                                            "/CONFIGURE_FIREWALL ",
                                            "/NOSQL",
											"\n",
											"powershell.exe ",
                                            "-ExecutionPolicy",
                                            " RemoteSigned",
                                            " C:\\cfn\\scripts\\configureXD.ps1 -DomainNetBIOSName ",
                                            {
                                                "Ref" : "DomainNetBIOSName"
                                            },
                                            " -DomainAdminUser ",
                                            {
                                                "Ref" : "DomainAdminUser"
                                            },
                                            " -DomainAdminPassword ",
											{
                                                "Ref" : "DomainAdminPassword"
                                            },
											" -DDCServerNetBIOSName1 ",
											{
                                                "Ref" : "DDCServerNetBIOSName1"
                                            },
											" -WSFCNode1NetBIOSName ",
											{
                                                "Ref" : "WSFCNode1NetBIOSName"
                                            }
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands" : {
                            "a-create-folder"                  : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command ",
                                            "\"",
                                            "Invoke-Command -ScriptBlock {New-Item -ItemType directory -Path c:\\ -Name XDinstall} -ComputerName ",
                                            {
                                                "Ref" : "ADServerNetBIOSName1"
                                            },
                                            " -Credential ",
                                            "(New-Object System.Management.Automation.PSCredential('",
                                            {
                                                "Ref" : "DomainNetBIOSName"
                                            },
                                            "\\",
                                            {
                                                "Ref" : "DomainAdminUser"
                                            },
                                            "',",
                                            "(ConvertTo-SecureString ",
                                            {
                                                "Ref" : "DomainAdminPassword"
                                            },
                                            " -AsPlainText -Force))) ",
                                            "\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            },
                            "b-create-share"                   : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command ",
                                            "\"",
                                            "Invoke-Command -ScriptBlock { New-SmbShare -Name xdinstall -Path c:\\xdinstall -FullAccess everyone } -ComputerName ",
                                            {
                                                "Ref" : "ADServerNetBIOSName1"
                                            },
                                            " -Credential ",
                                            "(New-Object System.Management.Automation.PSCredential('",
                                            {
                                                "Ref" : "DomainNetBIOSName"
                                            },
                                            "\\",
                                            {
                                                "Ref" : "DomainAdminUser"
                                            },
                                            "',",
                                            "(ConvertTo-SecureString ",
                                            {
                                                "Ref" : "DomainAdminPassword"
                                            },
                                            " -AsPlainText -Force))) ",
                                            "\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            },
                            "c-execute-powershell-DownloadXD" : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-ExecutionPolicy",
                                            " RemoteSigned",
                                            " C:\\cfn\\scripts\\DownloadXDISO.ps1 -XDVersion ",
                                            {
                                                "Ref" : "XDVersion"
                                            },
                                            " -DestServer ",
                                            {
                                                "Ref" : "ADServerNetBIOSName1"
                                            },
                                            " -DestShare XDinstall"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            },
                            "d-execute-powershell-script-AddUserToGroup" : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-ExecutionPolicy",
                                            " RemoteSigned",
                                            " C:\\cfn\\scripts\\AddUserToGroup.ps1 -UserName ",
                                            {
                                                "Ref" : "DomainAdminUser"
                                            },
                                            " -ServerName ",
                                            {
                                                "Ref" : "DDCServerNetBIOSName1"
                                            },
                                            " -DomainNetBIOSName ",
                                            {
                                                "Ref" : "DomainNetBIOSName"
                                            },
                                            " -GroupName \"Administrators\"",
                                            "\n"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            },
                            "e-enable-autologon"                         : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command ",
                                            "\"New-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name AutoAdminLogon -Value 1",
                                            ";",
                                            "New-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name DefaultUserName -Value ",
                                            {
                                                "Ref" : "DomainAdminUser"
                                            },
                                            "@",
                                            {
                                                "Ref" : "DomainDNSName"
                                            },
                                            " | out-null",
                                            ";",
                                            "New-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name DefaultPassword -Value ",
                                            {
                                                "Ref" : "DomainAdminPassword"
                                            },
                                            "\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            },
                            "f-set-startup-script"                       : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command ",
                                            "\"New-ItemProperty -Path HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce -Name InstallXDDDC -Value C:\\Users\\Default\\Desktop\\InstallXDDDC.bat",
                                            "\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            },
                            "g-reboot"                                   : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command Restart-Computer -Force"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "forever"
                            },
                            "h-force-ad-replication"                     : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command ",
                                            "\"Invoke-Command -Scriptblock{ repadmin /syncall /A /e /P } -ComputerName ",
                                            {
                                                "Ref" : "ADServerNetBIOSName1"
                                            },
                                            " -Credential ",
                                            "(New-Object System.Management.Automation.PSCredential('",
                                            {
                                                "Ref" : "DomainNetBIOSName"
                                            },
                                            "\\",
                                            {
                                                "Ref" : "DomainAdminUser"
                                            },
                                            "',",
                                            "(ConvertTo-SecureString ",
                                            {
                                                "Ref" : "DomainAdminPassword"
                                            },
                                            " -AsPlainText -Force))) ",
                                            "\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            },
                            "i-cleanup-registry"                         : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command ",
                                            "\"Remove-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name AutoAdminLogon",
                                            ";",
                                            "Remove-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name DefaultUserName",
                                            ";",
                                            "Remove-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name DefaultPassword",
                                            "\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "900"
                            }
                        }
                    },
                    "finalize"         : {
                        "commands" : {
                            "1-signal-success" : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "cfn-signal.exe -e 0 \"",
                                            {
                                                "Ref" : "XD7DDC1WaitHandle"
                                            },
                                            "\""
                                        ]
                                    ]
                                }
                            }
                        }
                    }
                }
            },
			"Properties":{
                "ImageId" : {
                    "Fn::FindInMap" : [
                        "AWSRegionArch2AMI",
                        {
                            "Ref" : "AWS::Region"
                        },
                        {
                            "Fn::FindInMap" : [
                                "AWSInstanceType2Arch",
                                {
                                    "Ref" : "DDCInstanceType"
                                },
                                "Arch"
                            ]
                        }
                    ]
                },
                "InstanceType" : {
                    "Ref" : "DDCInstanceType"
                },
                "NetworkInterfaces" : [
                    {
                        "DeleteOnTermination" : "true",
                        "DeviceIndex"         : 0,
                        "SubnetId"            : {
                            "Ref" : "InfraSubnet1Id"
                        },
                        "GroupSet"            : [
                            {
                                "Ref" : "DomainMemberSGID"
                            },
							{
								"Ref" : "DDCSGID"
							}
                        ]
                    }
                ],
				"Tags":[
					{
						"Key":"Name",
						"Value":{
							"Ref":"DDCServerNetBIOSName1"
						}
					}	
				],
				"KeyName":{
					"Ref":"KeyPairName"
				},
                "UserData"            : {
                    "Fn::Base64" : {
                        "Fn::Join" : [
                            "",
                            [
                                "<script>\n",
                                "cfn-init.exe -v -c config -s ",
                                {
                                    "Ref" : "AWS::StackId"
                                },
                                " -r XD7DDC1 ",
                                " --region ",
                                {
                                    "Ref" : "AWS::Region"
                                },
                                "\n",
                                "</script>"
                            ]
                        ]
                    }
                }
			}
      },
		"XD7DDC2":{
			"Type":"AWS::EC2::Instance",
            "DependsOn" : "XD7DDC1WaitCondition",
			"Metadata":{
				"AWS::CloudFormation::Init":{
					"configSets":{
						"config":[
							"CFNsetup",
							"rename",
							"join",
							"installXD",
							"finalize"
						]
					},
                    "CFNsetup"   : {
                        "files" : {
                            "c:\\cfn\\cfn-hup.conf" : {
                                "content" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "[main]\n",
                                            "stack=",
                                            {
                                                "Ref" : "AWS::StackId"
                                            },
                                            "\n",
                                            "region=",
                                            {
                                                "Ref" : "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            },
                            "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf" : {
                                "content" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "[cfn-auto-reloader-hook]\n",
                                            "triggers=post.update\n",
                                            "path=Resources.XD7DDC2.Metadata.AWS::CloudFormation::Init\n",
                                            "action=cfn-init.exe -v -s ",
                                            {
                                                "Ref" : "AWS::StackId"
                                            },
                                            " -r XD7DDC2",
                                            " --region ",
                                            {
                                                "Ref" : "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                }
                            }
                        },
                        "services" : {
                            "windows" : {
                                "cfn-hup" : {
                                    "enabled" : "true",
                                    "ensureRunning" : "true",
                                    "files"         : [
                                        "c:\\cfn\\cfn-hup.conf",
                                        "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        },
						"commands" : {
                            "a-set-execution-policy" : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -command Set-ExecutionPolicy RemoteSigned -Force"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            }
                        }
                    },
                    "rename"     : {
                        "commands" : {
                            "1-execute-powershell-script-RenameComputer" : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command Rename-Computer -NewName ",
                                            {
                                                "Ref" : "DDCServerNetBIOSName2"
                                            },
                                            " -Restart"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "forever"
                            }
                        }
                    },
                    "join"       : {
                        "commands" : {
                            "a-set-dns-servers" : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command ",
                                            "\"",
                                            "Get-NetAdapter | Set-DnsClientServerAddress -ServerAddresses ",
                                            {
                                                "Ref" : "ADServer2PrivateIp"
                                            },
                                            ",",
                                            {
                                                "Ref" : "ADServer1PrivateIp"
                                            },
                                            "\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "30"
                            },
                            "b-join-domain"     : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-Command \"",
                                            "Add-Computer -DomainName ",
                                            {
                                                "Ref" : "DomainDNSName"
                                            },
                                            " -Credential ",
                                            "(New-Object System.Management.Automation.PSCredential('",
                                            {
                                                "Ref" : "DomainNetBIOSName"
                                            },
                                            "\\",
                                            {
                                                "Ref" : "DomainAdminUser"
                                            },
                                            "',",
                                            "(ConvertTo-SecureString ",
                                            {
                                                "Ref" : "DomainAdminPassword"
                                            },
                                            " -AsPlainText -Force))) ",
                                            "-Restart\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "forever"
                            }
                        }
                    },
                    "installXD"       : {
                        "files" : {
                            "C:\\cfn\\scripts\\AddUserToGroup.ps1" : {
                                "content" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "Param(",
                                            "\n",
                                            "[Parameter(Mandatory=$True)]",
                                            "\n",
                                            "[string]$ServerName,",
                                            "\n",
                                            "[Parameter(Mandatory=$True)]",
                                            "\n",
                                            "[string]$GroupName,",
                                            "\n",
                                            "[Parameter(Mandatory=$True)]",
                                            "\n",
                                            "[string]$DomainNetBIOSName,",
                                            "\n",
                                            "[Parameter(Mandatory=$True)]",
                                            "\n",
                                            "[string]$UserName",
                                            "\n",
                                            ")",
                                            "$de = [ADSI]\"WinNT://$ServerName/$GroupName,group\"",
                                            "\n",
                                            "$de.psbase.Invoke(\"Add\",([ADSI]\"WinNT://$DomainNetBIOSName/$UserName\").path)",
                                            "\n"
                                        ]
                                    ]
                                }
                            },
							"c:\\cfn\\scripts\\configureXD.ps1" : {
                                "source" : "https://s3.amazonaws.com/cf-XenDesktop/RA/Scripts/XD7-DC2-Config.ps1"
                            },
                            "C:\\Users\\Default\\Desktop\\InstallXDDDC.bat" : {
                                "content" : {
                                    "Fn::Join" : [
                                        "",
                                        [
											"powershell.exe -command Install-WindowsFeature NET-Framework-Core",
											"\n",
                                            "powershell.exe -command \"dir \\\\",
                                            {
                                                "Ref" : "ADServerNetBIOSName1"
                                            },
                                            "\\XDinstall\\*.iso | Mount-DiskImage\"",
                                            "\n",
											"\"",
											"D:\\X64\\XenDesktop Setup\\XENDESKTOPSERVERSETUP.EXE",
											"\" ",
                                            "/COMPONENTS ",
                                            "CONTROLLER,DESKTOPSTUDIO,DESKTOPDIRECTOR,STOREFRONT ",
                                            "/PASSIVE ",
                                            "/NOREBOOT ",
                                            "/CONFIGURE_FIREWALL ",
                                            "/NOSQL",
											"\n",
											"powershell.exe ",
                                            "-ExecutionPolicy",
                                            " RemoteSigned",
                                            " C:\\cfn\\scripts\\configureXD.ps1 -DomainNetBIOSName ",
                                            { "Ref" : "DomainNetBIOSName" },
                                            " -DomainAdminUser ",
                                            { "Ref" : "DomainAdminUser" },
                                            " -DomainAdminPassword ",
											{ "Ref" : "DomainAdminPassword" },
											" -DDCServerNetBIOSName1 ",
											{ "Ref" : "DDCServerNetBIOSName1" }
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands" : {
                            "a-execute-powershell-script-AddUserToGroup" : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe ",
                                            "-ExecutionPolicy",
                                            " RemoteSigned",
                                            " C:\\cfn\\scripts\\AddUserToGroup.ps1 -UserName ",
                                            {
                                                "Ref" : "DomainAdminUser"
                                            },
                                            " -ServerName ",
                                            {
                                                "Ref" : "DDCServerNetBIOSName2"
                                            },
                                            " -DomainNetBIOSName ",
                                            {
                                                "Ref" : "DomainNetBIOSName"
                                            },
                                            " -GroupName \"Administrators\"",
                                            "\n"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            },
                            "b-enable-autologon"                         : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command ",
                                            "\"New-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name AutoAdminLogon -Value 1",
                                            ";",
                                            "New-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name DefaultUserName -Value ",
                                            {
                                                "Ref" : "DomainAdminUser"
                                            },
                                            "@",
                                            {
                                                "Ref" : "DomainDNSName"
                                            },
                                            ";",
                                            "New-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name DefaultPassword -Value ",
                                            {
                                                "Ref" : "DomainAdminPassword"
                                            },
                                            "\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            },
                            "c-set-startup-script"                       : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command ",
                                            "\"New-ItemProperty -Path HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce -Name InstallXDDDC -Value C:\\Users\\Default\\Desktop\\InstallXDDDC.bat",
                                            "\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "0"
                            },
                            "d-reboot"                                   : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command Restart-Computer -Force"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "forever"
                            },
                            "e-cleanup-registry"                         : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "powershell.exe -Command ",
                                            "\"Remove-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name AutoAdminLogon",
											";",
                                            "Remove-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name DefaultUserName",
											";",
                                            "Remove-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' -Name DefaultPassword",
                                            "\""
                                        ]
                                    ]
                                },
                                "waitAfterCompletion" : "900"
                            }
                        }
                    },
                    "finalize"         : {
                        "commands" : {
                            "1-signal-success" : {
                                "command" : {
                                    "Fn::Join" : [
                                        "",
                                        [
                                            "cfn-signal.exe -e 0 \"",
                                            {
                                                "Ref" : "XD7DDC2WaitHandle"
                                            },
                                            "\""
                                        ]
                                    ]
                                }
                            }
                        }
                    }
				}
			},
			"Properties":{
                "ImageId" : {
                    "Fn::FindInMap" : [
                        "AWSRegionArch2AMI",
                        {
                            "Ref" : "AWS::Region"
                        },
                        {
                            "Fn::FindInMap" : [
                                "AWSInstanceType2Arch",
                                {
                                    "Ref" : "DDCInstanceType"
                                },
                                "Arch"
                            ]
                        }
                    ]
                },
                "InstanceType" : {
                    "Ref" : "DDCInstanceType"
                },
                "NetworkInterfaces" : [
                    {
                        "DeleteOnTermination" : "true",
                        "DeviceIndex"         : 0,
                        "SubnetId"            : {
                            "Ref" : "InfraSubnet2Id"
                        },
                        "GroupSet"            : [
                            {
                                "Ref" : "DomainMemberSGID"
                            },
							{
								"Ref" : "DDCSGID"
							}
                        ]
                    }
                ],
				"Tags":[
					{
						"Key":"Name",
						"Value":{
							"Ref":"DDCServerNetBIOSName2"
						}
					}	
				],
				"KeyName":{
					"Ref":"KeyPairName"
				},
                "UserData"            : {
                    "Fn::Base64" : {
                        "Fn::Join" : [
                            "",
                            [
                                "<script>\n",
                                "cfn-init.exe -v -c config -s ",
                                {
                                    "Ref" : "AWS::StackId"
                                },
                                " -r XD7DDC2 ",
                                " --region ",
                                {
                                    "Ref" : "AWS::Region"
                                },
                                "\n",
                                "</script>"
                            ]
                        ]
                    }
                }
				}
		},
		"XD7DDC1WaitCondition" : {
			"Type" : "AWS::CloudFormation::WaitCondition",
			"DependsOn" : "XD7DDC1",
			"Properties" : {
				"Handle" : {"Ref" : "XD7DDC1WaitHandle"},
				"Timeout" : "3000"
			}
		},
		"XD7DDC1WaitHandle" : {
			"Type" : "AWS::CloudFormation::WaitConditionHandle"
		},
		"XD7DDC2WaitCondition" : {
			"Type" : "AWS::CloudFormation::WaitCondition",
			"DependsOn" : "XD7DDC2",
			"Properties" : {
				"Handle" : {"Ref" : "XD7DDC2WaitHandle"},
				"Timeout" : "3000"
			}
		},
		"XD7DDC2WaitHandle" : {
			"Type" : "AWS::CloudFormation::WaitConditionHandle"
		}
	},

	"Outputs" : {
			"DesktopDeliveryController1":{
				"Description":"IP address of the XenDesktop 7 Desktop Delivery Controller in AZ1",
				"Value":{
					"Fn::GetAtt":[
						"XD7DDC1",
						"PrivateIp"
					]
				}
			},
			"DesktopDeliveryController2":{
				"Description":"IP address of the XenDesktop 7 Desktop Delivery Controller in AZ2",
				"Value":{
					"Fn::GetAtt":[
						"XD7DDC2",
						"PrivateIp"
					]
				}
			}
	}  
}
